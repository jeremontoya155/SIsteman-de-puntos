<!-- Nueva Promoci√≥n Header -->
<div class="nueva-promocion-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="nueva-promocion-title">
                <i class="fas fa-megaphone me-3"></i>
                Nueva Promoci√≥n
            </h1>
            <p class="nueva-promocion-subtitle">Crea una promoci√≥n espec√≠fica para una categor√≠a de clientes</p>
        </div>
        <a href="/promociones" class="back-btn">
            <i class="fas fa-arrow-left me-2"></i>
            Volver a Lista
        </a>
    </div>
</div>

<!-- Formulario de nueva promoci√≥n -->
<div class="promocion-form-container">
    <div class="promocion-form-card">
        <% if (error) { %>
            <div class="form-alert error">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <%= error %>
            </div>
        <% } %>
        
        <form method="POST" action="/promociones" class="promocion-form">
            <!-- Informaci√≥n B√°sica -->
            <div class="form-section">
                <div class="section-header">
                    <h5 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Informaci√≥n de la Promoci√≥n
                    </h5>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="titulo" class="form-label">T√≠tulo de la Promoci√≥n *</label>
                        <input type="text" class="form-input" id="titulo" name="titulo" 
                               placeholder="Ej: Descuento especial de temporada" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoria_id" class="form-label">Categor√≠a Objetivo *</label>
                        <select class="form-select" id="categoria_id" name="categoria_id" required>
                            <option value="">Seleccionar categor√≠a...</option>
                            <% categorias.forEach(categoria => { %>
                                <option value="<%= categoria.id %>">
                                    <%= categoria.nombre %>
                                </option>
                            <% }); %>
                        </select>
                        <small class="form-help">Solo los clientes de esta categor√≠a recibir√°n la promoci√≥n</small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="descripcion" class="form-label">Descripci√≥n Detallada</label>
                        <textarea class="form-textarea" id="descripcion" name="descripcion" rows="3"
                                  placeholder="Describe los detalles de la promoci√≥n, condiciones, productos incluidos, etc."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Fechas de Vigencia -->
            <div class="form-section">
                <div class="section-header">
                    <h5 class="section-title">
                        <i class="fas fa-calendar"></i>
                        Per√≠odo de Vigencia
                    </h5>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fecha_inicio" class="form-label">Fecha de Inicio *</label>
                        <input type="date" class="form-input" id="fecha_inicio" name="fecha_inicio" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_fin" class="form-label">Fecha de Fin *</label>
                        <input type="date" class="form-input" id="fecha_fin" name="fecha_fin" required>
                    </div>
                </div>
                
                <div class="date-preview" id="datePreview" style="display: none;">
                    <div class="date-range">
                        <div class="date-start">
                            <i class="fas fa-play-circle"></i>
                            <span id="previewStart">-</span>
                        </div>
                        <div class="date-separator">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="date-end">
                            <i class="fas fa-stop-circle"></i>
                            <span id="previewEnd">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mensaje WhatsApp -->
            <div class="form-section">
                <div class="section-header">
                    <h5 class="section-title">
                        <i class="fab fa-whatsapp"></i>
                        Mensaje de WhatsApp
                    </h5>
                </div>
                
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="mensaje_personalizado" class="form-label">Mensaje Personalizado</label>
                        <textarea class="form-textarea whatsapp-textarea" id="mensaje_personalizado" 
                                  name="mensaje_personalizado" rows="4"
                                  placeholder="¬°Hola [NOMBRE]! üéâ Te tenemos una oferta especial..."></textarea>
                        <div class="form-help">
                            <i class="fas fa-info-circle me-1"></i>
                            Usa <code>[NOMBRE]</code> para incluir el nombre del cliente autom√°ticamente.
                        </div>
                    </div>
                </div>
                
                <!-- Plantillas de mensaje -->
                <div class="templates-section">
                    <h6 class="templates-title">
                        <i class="fas fa-lightbulb me-1"></i>
                        Plantillas predefinidas
                    </h6>
                    <div class="templates-grid">
                        <button type="button" class="template-btn" 
                                data-mensaje="¬°Hola [NOMBRE]! üéâ Tenemos una promoci√≥n especial solo para ti. ¬°No te la pierdas!">
                            <i class="fas fa-percent"></i>
                            <span>Promoci√≥n General</span>
                        </button>
                        
                        <button type="button" class="template-btn" 
                                data-mensaje="¬°[NOMBRE]! üõçÔ∏è Como cliente VIP, tienes descuentos exclusivos esta semana. ¬°Aprovecha!">
                            <i class="fas fa-crown"></i>
                            <span>Descuento VIP</span>
                        </button>
                        
                        <button type="button" class="template-btn" 
                                data-mensaje="üì¶ ¬°Hola [NOMBRE]! Ya lleg√≥ el stock que esperabas. Ven a verlo antes que se agote.">
                            <i class="fas fa-box"></i>
                            <span>Llegada de Stock</span>
                        </button>
                        
                        <button type="button" class="template-btn" 
                                data-mensaje="üéÇ ¬°Feliz cumplea√±os [NOMBRE]! Tenemos un regalo especial para ti. ¬°Pasa a retirarlo!">
                            <i class="fas fa-birthday-cake"></i>
                            <span>Cumplea√±os</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Vista Previa WhatsApp -->
            <div class="whatsapp-preview-section">
                <div class="preview-header">
                    <h6 class="preview-title">
                        <i class="fab fa-whatsapp me-2"></i>
                        Vista Previa del Mensaje
                    </h6>
                </div>
                
                <div class="whatsapp-preview-container">
                    <div class="whatsapp-header">
                        <div class="whatsapp-contact">
                            <div class="contact-avatar">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">Tu Negocio</div>
                                <div class="contact-status">en l√≠nea</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="whatsapp-messages">
                        <div class="whatsapp-message sent" id="whatsapp-preview">
                            <div class="message-content">
                                <div class="message-title" id="preview-title">
                                    <strong>üéØ [T√≠tulo de la promoci√≥n]</strong>
                                </div>
                                <div class="message-text" id="preview-message">
                                    Completa los campos para ver la vista previa del mensaje
                                </div>
                            </div>
                        </div>
                        <div class="message-time">Enviado ahora</div>
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div class="info-section">
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="info-content">
                        <h6>Consejos para promociones efectivas</h6>
                        <ul>
                            <li>Usa emojis para hacer el mensaje m√°s atractivo üéâ</li>
                            <li>Incluye una llamada a la acci√≥n clara</li>
                            <li>Menciona la fecha l√≠mite de la promoci√≥n</li>
                            <li>Personaliza el mensaje seg√∫n la categor√≠a del cliente</li>
                            <li>Mant√©n el mensaje corto y directo</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div class="form-actions">
                <a href="/promociones" class="cancel-btn">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </a>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save me-2"></i>
                    Crear Promoci√≥n
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Funci√≥n para actualizar la vista previa
function actualizarVistaPrevia() {
    const titulo = document.getElementById('titulo').value || '[T√≠tulo de la promoci√≥n]';
    const descripcion = document.getElementById('descripcion').value || '[Descripci√≥n]';
    const mensajePersonalizado = document.getElementById('mensaje_personalizado').value;
    
    let mensaje;
    if (mensajePersonalizado) {
        mensaje = mensajePersonalizado.replace(/\[NOMBRE\]/g, 'Juan P√©rez');
    } else {
        mensaje = `¬°Hola Juan P√©rez! üì¢ ${titulo}: ${descripcion}`;
    }
    
    document.getElementById('preview-title').innerHTML = `<strong>üéØ ${titulo}</strong>`;
    document.getElementById('preview-message').textContent = mensaje;
}

// Actualizar preview de fechas
function actualizarPreviewFechas() {
    const fechaInicio = document.getElementById('fecha_inicio').value;
    const fechaFin = document.getElementById('fecha_fin').value;
    const preview = document.getElementById('datePreview');
    
    if (fechaInicio && fechaFin) {
        const inicio = new Date(fechaInicio).toLocaleDateString('es-ES');
        const fin = new Date(fechaFin).toLocaleDateString('es-ES');
        
        document.getElementById('previewStart').textContent = inicio;
        document.getElementById('previewEnd').textContent = fin;
        
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Event listeners para actualizar vista previa
document.getElementById('titulo').addEventListener('input', actualizarVistaPrevia);
document.getElementById('descripcion').addEventListener('input', actualizarVistaPrevia);
document.getElementById('mensaje_personalizado').addEventListener('input', actualizarVistaPrevia);
document.getElementById('fecha_inicio').addEventListener('change', actualizarPreviewFechas);
document.getElementById('fecha_fin').addEventListener('change', actualizarPreviewFechas);

// Botones de plantillas
document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('mensaje_personalizado').value = this.dataset.mensaje;
        actualizarVistaPrevia();
        
        // Efecto visual en el bot√≥n seleccionado
        document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        
        setTimeout(() => {
            this.classList.remove('selected');
        }, 1000);
    });
});

// Establecer fecha m√≠nima como hoy
const hoy = new Date().toISOString().split('T')[0];
document.getElementById('fecha_inicio').min = hoy;
document.getElementById('fecha_fin').min = hoy;

// Validar que fecha fin sea posterior a fecha inicio
document.getElementById('fecha_inicio').addEventListener('change', function() {
    document.getElementById('fecha_fin').min = this.value;
});

// Contador de caracteres para el mensaje
const textarea = document.getElementById('mensaje_personalizado');
const contadorContainer = document.createElement('div');
contadorContainer.className = 'character-counter';
textarea.parentNode.appendChild(contadorContainer);

textarea.addEventListener('input', function() {
    const caracteres = this.value.length;
    const limite = 1000; // L√≠mite recomendado para WhatsApp
    
    contadorContainer.innerHTML = `
        <small class="form-help ${caracteres > limite ? 'text-danger' : ''}">
            ${caracteres}/${limite} caracteres ${caracteres > limite ? '(excede el l√≠mite recomendado)' : ''}
        </small>
    `;
});

// Inicializar vista previa
actualizarVistaPrevia();
actualizarPreviewFechas();

// Efecto de auto-resize en textarea
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});
</script>
